(function(c,i){typeof exports=="object"&&typeof module<"u"?module.exports=i():typeof define=="function"&&define.amd?define(i):(c=typeof globalThis<"u"?globalThis:c||self,c["anything-gpt"]=i())})(this,function(){"use strict";const c=t=>t!=null&&t.body?t:Promise.reject(t),i=t=>[t==null?void 0:t.status,t==null?void 0:t.statusCode].some(e=>e===200)?t:Promise.reject(t),f={model:"gpt-3.5-turbo",temperature:.7,max_tokens:4e3,stream:!0},m={api_key:"",markdown:!1},o=t=>({gpt:{...f,...t==null?void 0:t.gpt},instance:{...m,...t==null?void 0:t.instance}});async function g(t=o(),e,...a){if(!t.instance.api_key)throw new Error("ERROR: ChatGPT API KEY is undefined.");const s=Array.from(e).map((r,u)=>{const n=a[u];return r+(n instanceof Object?JSON.stringify(n):n||"")}).join("");return this.state.push({role:"user",content:s}),await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t.instance.api_key}`,"Content-Type":"application/json"},body:JSON.stringify({...t.gpt,messages:this.state})}).then(c).then(i).then(async r=>t.gpt.stream?this.stream(r):this.text(r)).catch(r=>this.error(r))}const l=t=>({state:t.state||[],storage:t.storage||new Map,text:async function(e){var a;return(a=t==null?void 0:t.text)==null?void 0:a.call(this,e)},stream:async function(e){var a;return(a=t==null?void 0:t.stream)==null?void 0:a.call(this,e)},error:async function(e){var a;return(a=t==null?void 0:t.error)==null?void 0:a.call(this,e)}}),y=t=>TextDecoder?new TextDecoder().decode(t,{stream:!0}):String.fromCharCode(...t),p=t=>{try{return JSON.parse(`["${t}"]`)[0]||t}catch{return t}},b=(t,e)=>{const a=t.body.getReader();return a.read().then(async function s({done:r,value:u}){if(r)return e("",!0);const n=/"content":\s*"((\\.|[^"])*)"/gm;for await(const d of y(u).matchAll(n))d[1]&&await e(p(d[1]));return a.read().then(s)})};return(t=>e=>(...a)=>new Promise((s,r)=>g.apply(l({state:[],async stream(u){return s((n,d=[])=>b(u,(h,O)=>d.push(h)&&O?Object.assign(this.state,{[this.state.length-1]:{role:"assistant",content:d.join("")}}):n(h)))},error:r}),[o({gpt:t.gpt,instance:Object.assign({api_key:e},t==null?void 0:t.instance)}),...a])))({gpt:{model:"gpt-3.5-turbo"}})});
